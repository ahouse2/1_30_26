# Build Log — 2026-02-12

## Scope
- Operational-readiness hardening and parity closure for graph, ingestion, and in-court presentation.
- Premium UI/UX polish pass focused on immediate courtroom usability.

## Completed
- Resolved graph backend patch-context instability by replacing stale-hunk edits with stable file-level updates for graph API/service paths.
- Implemented graph fact extraction vertical slice:
  - `GET /graph/facts` endpoint with `case_id` + `limit` support.
  - Typed API response models for facts and extraction payload.
  - Service extraction logic with claim generation, confidence scoring, and citation mapping.
- Wired graph facts into Graph Explorer sidebar:
  - Refresh control, confidence tags, and one-click citation open.
- Hardened frontend API routing to prevent non-JSON HTML fallbacks:
  - Set deterministic API base fallback in utility client.
  - Added resilient endpoint candidate probing in In-Court page for cases/evidence retrieval.
  - Normalized document and ingestion service paths to match active backend routes.
- Premium In-Court UX pass:
  - Live session clock with 1-second updates.
  - Court phase selector (Voir Dire/Direct/Cross/Redirect/Closing).
  - Narrative cue injection action tied to phase + selected exhibit.
  - Upgraded visual treatment for controls, phase chips, and presentation-mode atmosphere.

## Checklist Updates
- Updated `docs/plans/2026-02-09_gap_checklist_live.md` section 3:
  - Marked fact extraction pipeline complete.
  - Marked background graph refinement swarm complete.

## Validation
- Backend syntax validation:
  - `python -m py_compile backend/app/services/graph.py backend/app/api/graph.py backend/app/models/api.py`
- Frontend static checks:
  - `npx tsc --noEmit --pretty false`
  - `npm run -s build`
- Result: checks passed.

## Notes
- Remaining near-term work should prioritize timeline + in-court runtime behavior on real corpus uploads and final parity closure for outstanding modules in live checklist.

## Incremental Update (Parity Ops Slice)
- Implemented legacy parity operations backend (`/parity/*`) for production-facing use:
  - Task tracker CRUD (`GET/POST/PATCH /parity/tasks`).
  - Draft generation endpoint (`POST /parity/draft`) backed by drafting service and sectioned payload output.
  - Narrative discrepancy + sanctions risk endpoint (`POST /parity/analyze`) with deterministic scoring and trigger map.
  - Privilege + Bates endpoint (`POST /parity/privilege-bates`) using classifier service and line-level Bates assignment.
- Registered parity router in API bootstrap:
  - `backend/app/main.py` now includes `parity_ops.router`.
- Added premium parity operations UI panel and navigation:
  - New page `frontend/src/pages/ParityOpsPage.tsx` with:
    - case-scoped task tracker controls,
    - drafting run station,
    - discrepancy/sanctions analysis station,
    - privilege+Bates station.
  - New frontend API client: `frontend/src/services/parity_ops_api.ts`.
  - Route: `/parity-ops` and nav entry in `Layout`.
  - Added cohesive styling in `frontend/src/styles/index.css`.
- Updated live gap checklist:
  - Marked section 13 parity items complete for task tracker workflows/UI, drafting tooling, privilege+bates, and discrepancy/sanctions analysis.

### Validation (incremental)
- Backend syntax validation:
  - `python -m py_compile backend/app/services/parity_ops.py backend/app/api/parity_ops.py backend/app/main.py`
- Frontend build validation:
  - `npm -C frontend run -s build`
- Result: checks passed.

## Incremental Update (Court Sync Operationalization)
- Upgraded LACS connector from static stub to scrape-capable connector:
  - Added HTML fetch + parsing pipeline for search/calendar paths.
  - Added case/document fetch behaviors that return concrete preview payloads.
  - Relaxed LACS readiness to endpoint-driven mode (credential optional for public scrape workflows).
- Added cross-provider sync status endpoint:
  - `GET /courts/sync/status?case_id=...&jurisdiction=...`
  - Returns provider readiness, per-provider case document previews, upcoming court events, and payment queue summary.
- Extended `CourtIntegrationService`:
  - New `sync_status(...)` aggregator.
  - New `payment_queue_summary(...)` parser over append-only payment ledger.
- Wired CENTCOM UI to new sync endpoint:
  - Court desk now surfaces payment queue counters and case sync previews by provider.
  - Existing provider status + deadline radar + court search remain active.
- Updated live checklist section 8:
  - Marked LACS scrape, PACER/UniCourt payment queue, and court sync UI as complete.

### Validation (incremental)
- Backend syntax validation:
  - `python -m py_compile backend/app/services/court_integration.py backend/app/services/court_connectors/lacs.py backend/app/api/courts.py`
- Frontend build validation:
  - `npm -C frontend run -s build`
- Result: checks passed.

## Incremental Update (Ingestion Connector Expansion)
- Expanded ingestion source modes in Upload Evidence UI to fully expose LlamaHub-backed connectors:
  - Added `SharePoint`, `Gmail`, `IMAP Mailbox`, `Google Drive`, and enabled `OCR Batch`.
  - Existing `Cloud Drive`, `CourtListener`, and `Web URL` modes retained.
- Updated connector source-type mapping for queue submission:
  - New mappings for `sharepoint`, `gmail`, `imap`, `gdrive`, and `local` (OCR batch path flow).
- Added source-specific path/query placeholders to reduce operator errors during connector intake.
- Updated live checklist section 2:
  - Marked connector expansion + UI exposure complete.

### Validation (incremental)
- Backend syntax validation:
  - `python -m py_compile backend/app/services/parity_ops.py backend/app/services/court_integration.py backend/app/services/court_connectors/lacs.py backend/app/api/parity_ops.py backend/app/api/courts.py backend/app/main.py`
- Frontend build validation:
  - `npm -C frontend run -s build`
- Result: checks passed.

## Incremental Update (Court Integration Expansion + Graph Feed)
- Expanded court integration connectors for real operational use and graph persistence:
  - PACER connector upgraded from stub to resilient endpoint adapter (search/case/document/calendar paths with fallback parsing).
  - UniCourt connector upgraded from stub to resilient endpoint adapter (search/case/document/calendar paths with fallback parsing).
  - Case.law connector upgraded to direct HTTP integration with optional token mode and case/document payload shaping.
  - LegInfo connector added to active connector map so CA statutes are available in sync/search flows.
- Wired court data to knowledge graph ingestion path:
  - Court search results now upsert provider/query/case nodes + edges.
  - Court case sync now upserts case + document nodes and HAS_DOCUMENT relationships.
  - Court document fetch now upserts document linkage to case.
- Updated CENTCOM Court Search provider selector:
  - Added `CaseLaw (Appeals/Supreme)` and `CA LegInfo Statutes` options.
- Hardened credentials/schema parity:
  - Added missing court credential fields to `CredentialSettingsUpdate` model (`pacer`, `unicourt`, `lacs`, `caselaw`, `leginfo`).
  - Added LegInfo service status visibility in settings snapshot.

### Validation (incremental)
- Backend syntax validation:
  - `python -m py_compile backend/app/services/court_integration.py backend/app/services/court_connectors/caselaw.py backend/app/services/court_connectors/pacer.py backend/app/services/court_connectors/unicourt.py backend/app/services/court_connectors/leginfo.py backend/app/services/settings.py backend/app/models/api.py backend/app/config.py`
- Backend unit tests (targeted):
  - `python -m unittest backend.tests.test_court_connectors backend.tests.test_court_integration backend.tests.test_settings_court_credentials`
- Frontend build validation:
  - `npm -C frontend run -s build`
- Result: checks passed.

## Incremental Update (Presentation + Timeline Media + Forensics History Slice)
- Implemented production presentation export API with backend-generated outputs:
  - `POST /presentation/export` and `GET /presentation/export/{export_id}`
  - Supports `md`, `html`, `pdf`, and `xlsx` exports from binder payloads.
- Added `PresentationExportService` for deterministic binder package rendering:
  - Citation-aware markdown/html/pdf/xlsx output generation.
  - Export artifact persistence via export store.
- Upgraded In-Court Presentation UI export flow:
  - Replaced local-only HTML/print flow with backend export dispatch.
  - Added XLSX export action in UI.
- Added timeline media-hook generation endpoint + service:
  - `GET /timeline/media-hooks` now produces image/video exhibit hooks from filtered timeline events.
  - Timeline UI now includes “Generate Exhibit Media Hooks” action and queue summary.
- Implemented forensics report history/export/audit capabilities:
  - Added report version snapshots on each report persist.
  - Added API endpoints:
    - `GET /forensics/{case_id}/{doc_type}/{doc_id}/history`
    - `GET /forensics/{case_id}/{doc_type}/{doc_id}/audit`
    - `POST /forensics/{case_id}/{doc_type}/{doc_id}/export`
    - `GET /forensics/export/{export_id}`
  - Wired Forensics UI controls for JSON/MD/HTML exports, version history list, and audit stream preview.
- Updated live checklist:
  - Marked forensics history/export/audit complete.
  - Marked timeline media hooks complete.
  - Marked presentation export parity (PDF/XLSX/HTML with citations) complete.

### Validation (incremental)
- Backend syntax validation:
  - `python -m py_compile backend/app/models/api.py backend/app/services/forensics.py backend/app/api/forensics.py backend/app/services/timeline.py backend/app/api/timeline.py backend/app/api/presentation.py backend/app/services/presentation_exports.py backend/app/main.py`
- Backend targeted unit tests:
  - `python -m unittest backend.tests.test_court_connectors backend.tests.test_court_integration backend.tests.test_settings_court_credentials`
- Frontend build validation:
  - `npm -C frontend run -s build`
- Result: checks passed.

## Incremental Update (Forensics Custody Attribution Workflow)
- Expanded crypto forensics output with custody attribution leads:
  - Added `custody_attribution` to crypto tracing response models.
  - Integrated deterministic attribution workflow in tracer for exchange lead generation (Coinbase/Coinbase Pro/unclassified).
  - Attached legal process record scaffold per attribution lead using custodial attribution helper.
- Extended graph persistence for custody attribution:
  - Upserts custodian entities.
  - Adds wallet-to-custodian relationship edges with confidence and signal metadata.
- Updated Forensics UI:
  - Added custody-attribution section under Crypto tab with exchange, wallet, and confidence preview rows.
- Updated live checklist:
  - Marked custody attribution workflow item complete.

### Validation (incremental)
- Backend syntax validation:
  - `python -m py_compile backend/app/forensics/models.py backend/app/forensics/crypto_tracer.py backend/app/services/forensics.py backend/app/api/forensics.py backend/app/services/timeline.py backend/app/api/timeline.py backend/app/api/presentation.py backend/app/services/presentation_exports.py backend/app/main.py`
- Backend targeted unit tests:
  - `python -m unittest backend.tests.test_court_connectors backend.tests.test_court_integration backend.tests.test_settings_court_credentials`
- Frontend build validation:
  - `npm -C frontend run -s build`
- Result: checks passed.

## Incremental Update (Legacy Parity Runner + Hardening/Observability Closure)
- Implemented legacy behavior closure tooling in Parity Ops backend:
  - Added parity matrix service (`get_parity_matrix`) with scored summary.
  - Added legacy workflow catalog + runners (`deposition_prep`, `subpoena_prep`, `discovery_production`, `trial_preparation`).
  - Legacy workflow runs now persist to case-scoped parity ops artifacts.
- Expanded parity API surface:
  - `GET /parity/matrix`
  - `GET /parity/legacy-workflows`
  - `POST /parity/legacy-workflows/run`
- Upgraded Parity Ops UI panel:
  - Added live parity score badge.
  - Added legacy workflow runner card with workflow selector + operator prompt.
  - Added parity matrix card with status chips (implemented/partial/planned).
- Added regression coverage for parity service:
  - New tests in `backend/tests/test_parity_ops_service.py`.
- Docker hardening + multi-arch infrastructure:
  - Replaced backend image with hardened multi-stage Dockerfile (builder/runtime split, non-root runtime user, `tini`, reduced runtime packages).
  - Frontend Dockerfiles switched to deterministic `npm ci` installs.
  - Added multi-arch image pipeline workflow: `.github/workflows/docker-multiarch.yml` (amd64 + arm64, GHCR publish).
- Observability/alerting closure:
  - Added SLO threshold probe script: `tools/monitoring/slo_alert_probe.py`.
  - Added probe command to quickstart and NFR validation matrix.
- Updated checklists:
  - Marked legacy parity complete.
  - Marked docker hardening/multi-arch complete.
  - Marked observability dashboards/alerting complete.

### Validation (incremental)
- Backend syntax validation:
  - `python3 -m py_compile backend/app/services/parity_ops.py backend/app/api/parity_ops.py backend/tests/test_parity_ops_service.py`
- Backend unit tests:
  - `python3 -m unittest backend.tests.test_parity_ops_service backend.tests.test_court_connectors backend.tests.test_court_integration backend.tests.test_settings_court_credentials`
- Frontend build validation:
  - `npm -C frontend run -s build`
- Compose profile validation:
  - `docker compose --env-file infra/profiles/prod.env --profile prod --profile voice config`
- Result: checks passed.
